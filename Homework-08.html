<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.3.450">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">

<meta name="author" content="L. Harvey">

<title>Homework-08</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
</style>


<script src="Homework-08_files/libs/clipboard/clipboard.min.js"></script>
<script src="Homework-08_files/libs/quarto-html/quarto.js"></script>
<script src="Homework-08_files/libs/quarto-html/popper.min.js"></script>
<script src="Homework-08_files/libs/quarto-html/tippy.umd.min.js"></script>
<script src="Homework-08_files/libs/quarto-html/anchor.min.js"></script>
<link href="Homework-08_files/libs/quarto-html/tippy.css" rel="stylesheet">
<link href="Homework-08_files/libs/quarto-html/quarto-syntax-highlighting.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="Homework-08_files/libs/bootstrap/bootstrap.min.js"></script>
<link href="Homework-08_files/libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="Homework-08_files/libs/bootstrap/bootstrap.min.css" rel="stylesheet" id="quarto-bootstrap" data-mode="light">


</head>

<body class="fullcontent">

<div id="quarto-content" class="page-columns page-rows-contents page-layout-article">

<main class="content" id="quarto-document-content">

<header id="title-block-header" class="quarto-title-block default">
<div class="quarto-title">
<h1 class="title">Homework-08</h1>
</div>



<div class="quarto-title-meta">

    <div>
    <div class="quarto-title-meta-heading">Author</div>
    <div class="quarto-title-meta-contents">
             <p>L. Harvey </p>
          </div>
  </div>
    
  
    
  </div>
  

</header>

<section id="homework-08" class="level2">
<h2 class="anchored" data-anchor-id="homework-08">Homework 08</h2>
<p>Packages and set-up:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb1"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(tidyverse)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>── Attaching core tidyverse packages ──────────────────────── tidyverse 2.0.0 ──
✔ dplyr     1.1.4     ✔ readr     2.1.5
✔ forcats   1.0.0     ✔ stringr   1.5.0
✔ ggplot2   3.4.3     ✔ tibble    3.2.1
✔ lubridate 1.9.2     ✔ tidyr     1.3.0
✔ purrr     1.0.2     
── Conflicts ────────────────────────────────────────── tidyverse_conflicts() ──
✖ dplyr::filter() masks stats::filter()
✖ dplyr::lag()    masks stats::lag()
ℹ Use the conflicted package (&lt;http://conflicted.r-lib.org/&gt;) to force all conflicts to become errors</code></pre>
</div>
<div class="sourceCode cell-code" id="cb3"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(WeightIt)</span>
<span id="cb3-2"><a href="#cb3-2" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(cobalt)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code> cobalt (Version 4.5.3, Build Date: 2024-01-09)</code></pre>
</div>
</div>
</section>
<section id="exercise-8.1-evaluating-a-child-care-program" class="level2">
<h2 class="anchored" data-anchor-id="exercise-8.1-evaluating-a-child-care-program">Exercise 8.1: Evaluating a Child Care Program</h2>
<p>This dataset is taken from Gelman et al.&nbsp;(2020). The dataset contains measurements on the development of nearly 4500 children born in the 1980s.</p>
<p>The dataset is described as follows: “A subset of 290 of these children received special services in the first few years of life, including high-quality child care (five full days a week) in the second and third years of life as part of a formal intervention, the Infant Health and Development Program (IHDP). These children were targeted because they were born prematurely, had low birth weight (less than or equal to 2500 grams), and lived in the eight cities where the intervention took place. Children in the sample who did not receive the intervention exhibited a more representative range of birth timing and birth weight.</p>
<p>We want to evaluate the impact of this intervention on the children’s subsequent cognitive outcomes by comparing the outcomes for children in the intervention group to the outcomes in a comparison group of 4091 children who did not participate in the program. The outcome of interest is test score at age 3; this test is similar to an IQ measure, so we simplistically refer to these scores as IQ scores from now on” (Page 394-395).</p>
<p>Now let’s input the data:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb5"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true" tabindex="-1"></a>var_names <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">"momage"</span>, <span class="st">"b.marr"</span>, <span class="st">"momed"</span>, <span class="st">"work.dur"</span>, <span class="st">"prenatal"</span>, <span class="st">"cig"</span>, <span class="st">"booze"</span>, <span class="st">"sex"</span>, <span class="st">"first"</span>, <span class="st">"bw"</span>, <span class="st">"bwg"</span>, <span class="st">"preterm"</span>, <span class="st">"black"</span>, <span class="st">"hispanic"</span>, <span class="st">"white"</span>, <span class="st">"lths"</span>, <span class="st">"hs"</span>, <span class="st">"ltcoll"</span>, <span class="st">"college"</span>, <span class="st">"dayskidh"</span>, <span class="st">"st5"</span>, <span class="st">"st9"</span>, <span class="st">"st12"</span>, <span class="st">"st25"</span>, <span class="st">"st36"</span>, <span class="st">"st42"</span>, <span class="st">"st48"</span>, <span class="st">"st53"</span>, <span class="st">"st99"</span>, <span class="st">"income"</span>, <span class="st">"treat"</span>, <span class="st">"ppvtr.36"</span>)</span>
<span id="cb5-2"><a href="#cb5-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-3"><a href="#cb5-3" aria-hidden="true" tabindex="-1"></a>url <span class="ot">&lt;-</span> <span class="st">"https://raw.githubusercontent.com/avehtari/ROS-Examples/master/Childcare/data/cc2.csv"</span></span>
<span id="cb5-4"><a href="#cb5-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-5"><a href="#cb5-5" aria-hidden="true" tabindex="-1"></a>d <span class="ot">&lt;-</span> <span class="fu">read_csv</span>(url) <span class="sc">|&gt;</span> </span>
<span id="cb5-6"><a href="#cb5-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(<span class="fu">all_of</span>(var_names)) <span class="sc">|&gt;</span> </span>
<span id="cb5-7"><a href="#cb5-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="fu">across</span>(<span class="fu">matches</span>(<span class="st">"st</span><span class="sc">\\</span><span class="st">d{2}"</span>), as.integer))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>Rows: 4381 Columns: 64
── Column specification ────────────────────────────────────────────────────────
Delimiter: ","
chr  (1): sample
dbl (62): momage, momrace, b.marr, momed, work.dur, prenatal, cig, booze, se...
lgl  (1): st99

ℹ Use `spec()` to retrieve the full column specification for this data.
ℹ Specify the column types or set `show_col_types = FALSE` to quiet this message.</code></pre>
</div>
<div class="sourceCode cell-code" id="cb7"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb7-1"><a href="#cb7-1" aria-hidden="true" tabindex="-1"></a><span class="fu">glimpse</span>(d)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Rows: 4,381
Columns: 32
$ momage   &lt;dbl&gt; 33, 22, 13, 25, 19, 19, 26, 20, 23, 28, 32, 23, 29, 18, 25, 1…
$ b.marr   &lt;dbl&gt; 1, 0, 0, 1, 0, 0, 0, 1, 1, 1, 0, 0, 1, 0, 1, 0, 0, 1, 1, 0, 1…
$ momed    &lt;dbl&gt; 4, 1, 1, 4, 1, 2, 1, 1, 2, 2, 1, 2, 1, 1, 4, 1, 1, 1, 2, 1, 3…
$ work.dur &lt;dbl&gt; 1, 0, 0, 1, 0, 1, 1, 0, 1, 1, 1, 1, 0, 0, 1, 0, 1, 1, 1, 1, 1…
$ prenatal &lt;dbl&gt; 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1…
$ cig      &lt;dbl&gt; 0, 0, 0, 0, 1, 1, 1, 1, 0, 1, 1, 0, 0, 0, 0, 1, 1, 0, 0, 0, 1…
$ booze    &lt;dbl&gt; 0, 1, 0, 0, 0, 1, 0, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0…
$ sex      &lt;dbl&gt; 1, 1, 1, 1, 1, 0, 1, 0, 0, 1, 0, 0, 1, 1, 0, 1, 0, 1, 0, 1, 1…
$ first    &lt;dbl&gt; 0, 0, 1, 1, 0, 1, 0, 0, 0, 0, 0, 0, 1, 1, 0, 1, 0, 0, 0, 0, 1…
$ bw       &lt;dbl&gt; 1559, 2240, 1900, 1550, 2270, 1550, 2330, 2410, 1776, 2140, 2…
$ bwg      &lt;dbl&gt; 0, 1, 0, 0, 1, 0, 1, 1, 0, 1, 1, 0, 1, 1, 0, 1, 1, 1, 1, 1, 0…
$ preterm  &lt;dbl&gt; 10, 3, 6, 8, 5, 4, 9, 3, 6, 5, 5, 7, 6, 10, 8, 6, 7, 6, 6, 6,…
$ black    &lt;dbl&gt; 0, 1, 1, 1, 1, 1, 0, 0, 0, 1, 0, 1, 0, 1, 0, 0, 0, 0, 1, 1, 0…
$ hispanic &lt;dbl&gt; 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0…
$ white    &lt;dbl&gt; 1, 0, 0, 0, 0, 0, 1, 1, 1, 0, 1, 0, 1, 0, 1, 1, 1, 1, 0, 0, 1…
$ lths     &lt;dbl&gt; 0, 1, 1, 0, 1, 0, 1, 1, 0, 0, 1, 0, 1, 1, 0, 1, 1, 1, 0, 1, 0…
$ hs       &lt;dbl&gt; 0, 0, 0, 0, 0, 1, 0, 0, 1, 1, 0, 1, 0, 0, 0, 0, 0, 0, 1, 0, 0…
$ ltcoll   &lt;dbl&gt; 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1…
$ college  &lt;dbl&gt; 1, 0, 0, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1, 0, 0, 0, 0, 0, 0…
$ dayskidh &lt;dbl&gt; 31, 4, 9, 50, 4, 13, 8, 6, 30, 2, 3, 27, 13, 24, 71, 1, 6, 4,…
$ st5      &lt;dbl&gt; 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1…
$ st9      &lt;dbl&gt; 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0…
$ st12     &lt;int&gt; 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0…
$ st25     &lt;int&gt; 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0…
$ st36     &lt;int&gt; 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0…
$ st42     &lt;int&gt; 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0…
$ st48     &lt;int&gt; 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0…
$ st53     &lt;int&gt; 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0…
$ st99     &lt;int&gt; 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0…
$ income   &lt;dbl&gt; 42500.0000, 5000.0000, 12500.0000, 42500.0000, 5000.0000, 125…
$ treat    &lt;dbl&gt; 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1…
$ ppvtr.36 &lt;dbl&gt; 111.00000, 81.00000, 92.00000, 103.00000, 81.00000, 94.00000,…</code></pre>
</div>
</div>
<p>Note: Our outcome variable is <code>ppvtr.36</code> (which is “test score at age 3”).</p>
<p>If we want to view the dictionary for the study:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb9"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb9-1"><a href="#cb9-1" aria-hidden="true" tabindex="-1"></a>dict_url <span class="ot">&lt;-</span> <span class="st">"https://raw.githubusercontent.com/avehtari/ROS-Examples/master/Childcare/data/datadict.txt"</span></span>
<span id="cb9-2"><a href="#cb9-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-3"><a href="#cb9-3" aria-hidden="true" tabindex="-1"></a><span class="fu">read_file</span>(dict_url) <span class="sc">|&gt;</span> </span>
<span id="cb9-4"><a href="#cb9-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">writeLines</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Data Dictionary for Child Care example

The IHDP intervention was implemented in the 1980’s and targeted low
birth weight (less than 2500 grams), pre-term children.  They were
recruited at the time of birth.  It provided high quality child care
and other services in their first 3 years of life.  The comparison
group was pulled from a survey conducted during the same time period
called the National Survey of Longitudinal Youth.  At the time of the
intervention many of the original survey participants (first recruited
in 1979) had children. We have data from those children and their
mothers for an overlapping set of variables (below) as the IHDP
children.

The intervention for low-birth-weight children is described by
- Brooks-Gunn, J., Liaw, F. R., and Klebanov, P. K. (1992). Effects of
  early intervention on cognitive function of low birth weight preterm
  infants. Journal of Pediatrics 120, 350–359.
- Hill, J. L., Brooks-Gunn, J., and Waldfogel, J. (2003). Sustained
  effects of high participation in an early intervention for
  low-birth-weight premature infants. Developmental Psychology 39,
  730–744.

Data columns

"momage"   
mom age at time of birth

"b.marr"   
indicator for whether mom was married at birth

"momed"    
mother’s education level at the time she gave birth

"work.dur" 
indicator for whether mom worked in the year before she gave birth

"prenatal" 
indicator for whether mom received prenatal care

"cig"     
 indicator for whether mom smoked cigarettes while pregnant

"booze"    
indicator for whether mom drank alcohol while pregnant

"sex"      
indicator for whether child was born male or female

"first"    
indicator for whether child was the first born for the mother

"bw"       
child’s birth weight

"bwg"      
indicator for whether child was born low birth weight

"preterm" 
number of weeks preterm child was born

"black", "hispanic", "white"    
indicators for child’s race/ethnicity

"lths", "hs", "ltcoll", "college"  
indicators for mother’s education at time of birth

"dayskidh" 
number of days child was in the hospital after being born

"st5", "st9", "st12", "st25", "st36", "st42", "st48", "st53"    
indicator for state where household resides 

"st99"  
indicator for whether family  was living in state served by the ihdp

"income"   
family income one year after the child was born

"treat"   
indicator for whether family was allowed to receive IHDP services (1 = yes) 

"ppvtr.36"
IQ measured at age 36 months</code></pre>
</div>
</div>
</section>
<section id="exercise-8.1.1-exclusion" class="level2">
<h2 class="anchored" data-anchor-id="exercise-8.1.1-exclusion">Exercise 8.1.1: Exclusion</h2>
<p>Gelman et al.&nbsp;(2020) wrote, “We excluded the most severely low-birth-weight children (those at or below 1500 grams) from the sample because they are so different from the comparison sample.”</p>
<p>In your own words, answer the following:</p>
<p><u>Why did the authors decide to exclude these children? What problem could we encounter by not omitting them?</u></p>
<p>The authors decided to exclude these children because they were viewed as being “so different” from the children included in the comparison group. One reason to explain why these babies were excluded could be because they fell outside of the region of common support and thus did not have matches against which they could be compared.</p>
<p>The most obvious problem that we can face by omitting these babies is that dropping the “extreme” cases likely will dilute our treatment effect, meaning that our results will likely be less accurate than they could be.</p>
<p><u>Would <em>you</em> have excluded them from the dataset? Why?</u></p>
<p>I would not have excluded the tots because doing so may skew our results (for the reason I indicated in the question above). Simply stated, it’s never a good idea to cut data just to cut it, as doing so may inadvertently impact our results.</p>
</section>
<section id="exercise-8.1.2-covariate-balancing" class="level2">
<h2 class="anchored" data-anchor-id="exercise-8.1.2-covariate-balancing">Exercise 8.1.2: Covariate Balancing</h2>
<p><u>Look at the variables. Which ones are you planning to use for covariate balancing? Justify your answer, but keep it short!</u></p>
<p>Per Gelmen et al.&nbsp;(2020), the “IHDP intervention … targeted lowbirth weight, pre-term children” and “provided high quality child care” for the first three years of the children’s lives. Consequently, in order to balance the variables, there are certain variables that are more central to balancing than others.</p>
<p>In order to balance the covariates, I will focus on the following variables:</p>
<p><strong>Variables related to receiving treatment</strong></p>
<p>The first covariates to balance are the ones most central to receiving treatment:</p>
<ol type="1">
<li><code>bw</code> = The child’s birthweight</li>
<li><code>bwg</code> = The indicator for whether or not a child was born with a low birth weight</li>
<li><code>preterm</code> = The number of weeks preterm the child was born</li>
<li><code>st99</code> = The indicator for whether or not the family was living in a state served by the IHDP</li>
<li><code>st5</code>, <code>st9</code>, <code>st12</code>, <code>st25</code>, <code>st36</code>, <code>st42</code>, <code>st48</code>, and <code>st53</code> = The indicator for the state where the household resides</li>
</ol>
<p><strong>Variables about the pregnancy</strong></p>
<p>I also want to balance the variables that indicate more information about harm/risks that potentially occurred <em>during</em> the pregnancy:</p>
<ol type="1">
<li><code>prenatal</code> = The indicator for whether or not the mother received prenatal care</li>
<li><code>cig</code> = The indicator for whether or not the mother smoked cigarettes while pregnant</li>
<li><code>booze</code> = The indicator for whether or not the mother drank alcohol while pregnant</li>
<li><code>work.dur</code> = The indicator for whether or not the mother worked in the year before she gave birth</li>
</ol>
<p><strong>Variables about the mother</strong></p>
<p>Lastly, I want to balance some of the demographic information included in the data:</p>
<ol type="1">
<li><code>momage</code> = The mother’s age at the time of giving birth</li>
<li><code>momed</code> = The mother’s education level at the time of giving birth</li>
</ol>
</section>
<section id="exercise-8.1.3-using-weightit" class="level2">
<h2 class="anchored" data-anchor-id="exercise-8.1.3-using-weightit">Exercise 8.1.3: Using <code>WeightIt</code></h2>
<p>Having established the covariates on which we’ll be focusing, let’s get into the balancing process!</p>
<p><u>Use the <code>WeightIt</code> package and try to achieve balance before estimating the ATT for the effect of this child care program. You will have to do this three separate times, using 1) Propensity Scores 2) CBPS and 3) Entropy Balancing.</u></p>
<p><strong>Propensity Score Balancing</strong></p>
<div class="cell">
<div class="sourceCode cell-code" id="cb11"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb11-1"><a href="#cb11-1" aria-hidden="true" tabindex="-1"></a>treat_formula_1 <span class="ot">&lt;-</span> <span class="st">"treat ~ bw + bwg + preterm + st99 + st5 + st9 + st12 + st25 + st36 + st42 + st48 + st53 + prenatal + cig + booze + work.dur + momage + I(momage^2) + momed"</span></span>
<span id="cb11-2"><a href="#cb11-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-3"><a href="#cb11-3" aria-hidden="true" tabindex="-1"></a>W1 <span class="ot">&lt;-</span> <span class="fu">weightit</span>(<span class="fu">as.formula</span>(treat_formula_1), </span>
<span id="cb11-4"><a href="#cb11-4" aria-hidden="true" tabindex="-1"></a>               <span class="at">method =</span> <span class="st">"ps"</span>, </span>
<span id="cb11-5"><a href="#cb11-5" aria-hidden="true" tabindex="-1"></a>               <span class="at">estimand =</span> <span class="st">"ATT"</span>, </span>
<span id="cb11-6"><a href="#cb11-6" aria-hidden="true" tabindex="-1"></a>               <span class="at">data =</span> d)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>Warning: Some extreme weights were generated. Examine them with `summary()` and
maybe trim them with `trim()`.</code></pre>
</div>
<div class="sourceCode cell-code" id="cb13"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb13-1"><a href="#cb13-1" aria-hidden="true" tabindex="-1"></a><span class="fu">summary</span>(W1)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>                 Summary of weights

- Weight ranges:

        Min                                    Max
treated   1 ||                              1.0000
control   0 |---------------------------| 308.5993

- Units with the 5 most extreme weights by group:
                                                 
               5       4       3       2        1
 treated       1       1       1       1        1
            3956    1430    3679    3692     1915
 control 16.3758 24.2489 37.7355 39.0344 308.5993

- Weight statistics:

        Coef of Var   MAD Entropy # Zeros
treated       0.000 0.000  -0.000       0
control      39.817 1.959   6.544    2946

- Effective Sample Sizes:

           Control Treated
Unweighted 4091.       290
Weighted      2.58     290</code></pre>
</div>
<div class="sourceCode cell-code" id="cb15"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb15-1"><a href="#cb15-1" aria-hidden="true" tabindex="-1"></a><span class="fu">love.plot</span>(W1)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>Warning: Standardized mean differences and raw mean differences are present in the same plot. 
Use the `stars` argument to distinguish between them and appropriately label the x-axis.</code></pre>
</div>
<div class="cell-output-display">
<p><img src="Homework-08_files/figure-html/unnamed-chunk-4-1.png" class="img-fluid" width="672"></p>
</div>
</div>
<p>Huh. So, this first <code>love.plot</code> came out pretty clean in the first trial of balancing the propensity scores. <code>st53</code> kind of sucks, so let’s see if a different version of the formula works better. In the second go-around of the propensity score formula, we cut out all of the states except for <code>st99</code> (the indicator of whether or not a family was living in a state that the IHDP was serving).</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb17"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb17-1"><a href="#cb17-1" aria-hidden="true" tabindex="-1"></a>treat_formula_2 <span class="ot">&lt;-</span> <span class="st">"treat ~ bw + bwg + preterm + st99 + prenatal + cig + booze + work.dur + momage + I(momage^2) + momed"</span></span>
<span id="cb17-2"><a href="#cb17-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-3"><a href="#cb17-3" aria-hidden="true" tabindex="-1"></a>W2 <span class="ot">&lt;-</span> <span class="fu">weightit</span>(<span class="fu">as.formula</span>(treat_formula_2), </span>
<span id="cb17-4"><a href="#cb17-4" aria-hidden="true" tabindex="-1"></a>               <span class="at">method =</span> <span class="st">"ps"</span>, </span>
<span id="cb17-5"><a href="#cb17-5" aria-hidden="true" tabindex="-1"></a>               <span class="at">estimand =</span> <span class="st">"ATT"</span>, </span>
<span id="cb17-6"><a href="#cb17-6" aria-hidden="true" tabindex="-1"></a>               <span class="at">data =</span> d)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>Warning: Some extreme weights were generated. Examine them with `summary()` and
maybe trim them with `trim()`.</code></pre>
</div>
<div class="sourceCode cell-code" id="cb19"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb19-1"><a href="#cb19-1" aria-hidden="true" tabindex="-1"></a><span class="fu">summary</span>(W2)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>                 Summary of weights

- Weight ranges:

        Min                                   Max
treated   1  ||                            1.0000
control   0 |---------------------------| 44.4688

- Units with the 5 most extreme weights by group:
                                               
              10      8       7       6       2
 treated       1      1       1       1       1
            2801   2765    1133    1915    2802
 control 14.2603 16.331 18.6058 26.1673 44.4688

- Weight statistics:

        Coef of Var  MAD Entropy # Zeros
treated       0.000 0.00  -0.000       0
control      17.872 1.93   5.083    2916

- Effective Sample Sizes:

           Control Treated
Unweighted 4091.       290
Weighted     12.77     290</code></pre>
</div>
<div class="sourceCode cell-code" id="cb21"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb21-1"><a href="#cb21-1" aria-hidden="true" tabindex="-1"></a><span class="fu">love.plot</span>(W2)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>Warning: Standardized mean differences and raw mean differences are present in the same plot. 
Use the `stars` argument to distinguish between them and appropriately label the x-axis.</code></pre>
</div>
<div class="cell-output-display">
<p><img src="Homework-08_files/figure-html/unnamed-chunk-5-1.png" class="img-fluid" width="672"></p>
</div>
</div>
<p><em>Huh.</em> Funny enough, the covariates are now more out-of-whack than earlier (I’m looking at you, <code>preterm</code>).</p>
<p>Let’s keep pushing, though, and see if CBPS is kinder to us.</p>
<p><strong>Covariate Balancing Propensity Score (CBPS)</strong></p>
<div class="cell">
<div class="sourceCode cell-code" id="cb23"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb23-1"><a href="#cb23-1" aria-hidden="true" tabindex="-1"></a>CBPS1 <span class="ot">&lt;-</span> <span class="fu">weightit</span>(<span class="fu">as.formula</span>(treat_formula_1), </span>
<span id="cb23-2"><a href="#cb23-2" aria-hidden="true" tabindex="-1"></a>                  <span class="at">method =</span> <span class="st">"cbps"</span>, </span>
<span id="cb23-3"><a href="#cb23-3" aria-hidden="true" tabindex="-1"></a>                  <span class="at">estimand =</span> <span class="st">"ATT"</span>, </span>
<span id="cb23-4"><a href="#cb23-4" aria-hidden="true" tabindex="-1"></a>                  <span class="at">data =</span> d)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>Warning: Some extreme weights were generated. Examine them with `summary()` and
maybe trim them with `trim()`.</code></pre>
</div>
<div class="sourceCode cell-code" id="cb25"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb25-1"><a href="#cb25-1" aria-hidden="true" tabindex="-1"></a><span class="fu">summary</span>(CBPS1)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>                 Summary of weights

- Weight ranges:

        Min                                   Max
treated   1  ||                            1.0000
control   0 |---------------------------| 43.7008

- Units with the 5 most extreme weights by group:
                                                
               6       5       4       3       1
 treated       1       1       1       1       1
            3679    2802    1430    3692    1915
 control 13.5243 16.7644 18.2478 43.6551 43.7008

- Weight statistics:

        Coef of Var   MAD Entropy # Zeros
treated       0.000 0.000  -0.000       0
control      20.329 1.925   5.285       0

- Effective Sample Sizes:

           Control Treated
Unweighted 4091.       290
Weighted      9.88     290</code></pre>
</div>
<div class="sourceCode cell-code" id="cb27"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb27-1"><a href="#cb27-1" aria-hidden="true" tabindex="-1"></a><span class="fu">love.plot</span>(CBPS1)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>Warning: Large mean differences detected; you may not be using standardized
mean differences for continuous variables.</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Warning: Standardized mean differences and raw mean differences are present in the same plot. 
Use the `stars` argument to distinguish between them and appropriately label the x-axis.</code></pre>
</div>
<div class="cell-output-display">
<p><img src="Homework-08_files/figure-html/unnamed-chunk-6-1.png" class="img-fluid" width="672"></p>
</div>
</div>
<p>Again, <code>treat_formula_1</code> appears to be hanging in there! There is still a bit of wiggle in the visualization, with <code>preterm</code> and <code>momed</code> appearing to deviate the most from the balanced propensity scores.</p>
<p>Just for fun, let’s see what happens if we <em>don’t</em> overfit the CBPS.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb30"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb30-1"><a href="#cb30-1" aria-hidden="true" tabindex="-1"></a>CBPS2 <span class="ot">&lt;-</span> <span class="fu">weightit</span>(<span class="fu">as.formula</span>(treat_formula_1), </span>
<span id="cb30-2"><a href="#cb30-2" aria-hidden="true" tabindex="-1"></a>                  <span class="at">method =</span> <span class="st">"cbps"</span>, </span>
<span id="cb30-3"><a href="#cb30-3" aria-hidden="true" tabindex="-1"></a>                  <span class="at">estimand =</span> <span class="st">"ATT"</span>, </span>
<span id="cb30-4"><a href="#cb30-4" aria-hidden="true" tabindex="-1"></a>                  <span class="at">over =</span> <span class="cn">FALSE</span>, </span>
<span id="cb30-5"><a href="#cb30-5" aria-hidden="true" tabindex="-1"></a>                  <span class="at">data =</span> d)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>Warning: Some extreme weights were generated. Examine them with `summary()` and
maybe trim them with `trim()`.</code></pre>
</div>
<div class="sourceCode cell-code" id="cb32"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb32-1"><a href="#cb32-1" aria-hidden="true" tabindex="-1"></a><span class="fu">summary</span>(CBPS2)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>                 Summary of weights

- Weight ranges:

        Min                                   Max
treated   1  ||                            1.0000
control   0 |---------------------------| 36.3598

- Units with the 5 most extreme weights by group:
                                               
               5      4       3       2       1
 treated       1      1       1       1       1
            3956   3679    1430    3692     432
 control 22.8432 23.155 23.7836 34.0589 36.3598

- Weight statistics:

        Coef of Var   MAD Entropy # Zeros
treated       0.000 0.000  -0.000       0
control      13.916 1.927   4.777       0

- Effective Sample Sizes:

           Control Treated
Unweighted 4091.       290
Weighted     21.02     290</code></pre>
</div>
<div class="sourceCode cell-code" id="cb34"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb34-1"><a href="#cb34-1" aria-hidden="true" tabindex="-1"></a><span class="fu">love.plot</span>(CBPS2)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>Warning: Standardized mean differences and raw mean differences are present in the same plot. 
Use the `stars` argument to distinguish between them and appropriately label the x-axis.</code></pre>
</div>
<div class="cell-output-display">
<p><img src="Homework-08_files/figure-html/unnamed-chunk-7-1.png" class="img-fluid" width="672"></p>
</div>
</div>
<p>Oof. It got worse. Let us continue to overfit, then.</p>
<p><strong>Entropy Balancing</strong></p>
<p>Last but not least, let’s try using entropy balancing to adjust these covariates.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb36"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb36-1"><a href="#cb36-1" aria-hidden="true" tabindex="-1"></a>balance_beam <span class="ot">&lt;-</span> <span class="fu">weightit</span>(<span class="fu">as.formula</span>(treat_formula_1), </span>
<span id="cb36-2"><a href="#cb36-2" aria-hidden="true" tabindex="-1"></a>                         <span class="at">data =</span> d, </span>
<span id="cb36-3"><a href="#cb36-3" aria-hidden="true" tabindex="-1"></a>                         <span class="at">estimand =</span> <span class="st">"ATT"</span>, </span>
<span id="cb36-4"><a href="#cb36-4" aria-hidden="true" tabindex="-1"></a>                         <span class="at">method =</span> <span class="st">"ebal"</span>, </span>
<span id="cb36-5"><a href="#cb36-5" aria-hidden="true" tabindex="-1"></a>                         <span class="at">moments =</span> <span class="dv">3</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>Warning: The estimated weights do not balance the covariates, indicating the
optimization arrived at a degenerate solution. Try decreasing the number of
variables supplied to the optimization.</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Warning: All weights are `NA` or 0 in treatment group "0".</code></pre>
</div>
<div class="sourceCode cell-code" id="cb39"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb39-1"><a href="#cb39-1" aria-hidden="true" tabindex="-1"></a><span class="fu">summary</span>(balance_beam)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>                 Summary of weights

- Weight ranges:

        Min                                 Max
treated   1                              ||   1
control   0   ||                              0

- Units with the 5 most extreme weights by group:
                             
           5   4   3   2    1
 treated   1   1   1   1    1
         294 293 292 291 1435
 control   0   0   0   0    0

- Weight statistics:

        Coef of Var MAD Entropy # Zeros
treated           0   0       0       0
control                       0    4091

- Effective Sample Sizes:

           Control Treated
Unweighted    4091     290
Weighted               290</code></pre>
</div>
<div class="sourceCode cell-code" id="cb41"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb41-1"><a href="#cb41-1" aria-hidden="true" tabindex="-1"></a><span class="fu">love.plot</span>(balance_beam)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-error">
<pre><code>Error in `love.plot()`:
! All weights are zero when treat is "0".</code></pre>
</div>
<div class="sourceCode cell-code" id="cb43"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb43-1"><a href="#cb43-1" aria-hidden="true" tabindex="-1"></a><span class="fu">bal.plot</span>(balance_beam, <span class="at">which =</span> <span class="st">"both"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>No `var.name` was provided. Displaying balance for bw.</code></pre>
</div>
<div class="cell-output-display">
<p><img src="Homework-08_files/figure-html/unnamed-chunk-8-1.png" class="img-fluid" width="672"></p>
</div>
</div>
<p>Rats! Trying to run this entropy balance generates an output where the “estimated weights do not balance the covariates,” with a warning that “all weights are ‘NA’ or 0 in treatment group ‘0’.” (Oh my goodness, look at this hideous balance plot!)</p>
<p>Let’s try it again with our other formula.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb45"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb45-1"><a href="#cb45-1" aria-hidden="true" tabindex="-1"></a>balance_beam_2 <span class="ot">&lt;-</span> <span class="fu">weightit</span>(<span class="fu">as.formula</span>(treat_formula_2), </span>
<span id="cb45-2"><a href="#cb45-2" aria-hidden="true" tabindex="-1"></a>                         <span class="at">data =</span> d, </span>
<span id="cb45-3"><a href="#cb45-3" aria-hidden="true" tabindex="-1"></a>                         <span class="at">estimand =</span> <span class="st">"ATT"</span>, </span>
<span id="cb45-4"><a href="#cb45-4" aria-hidden="true" tabindex="-1"></a>                         <span class="at">method =</span> <span class="st">"ebal"</span>, </span>
<span id="cb45-5"><a href="#cb45-5" aria-hidden="true" tabindex="-1"></a>                         <span class="at">moments =</span> <span class="dv">3</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>Warning: The estimated weights do not balance the covariates, indicating the
optimization arrived at a degenerate solution. Try decreasing the number of
variables supplied to the optimization.</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Warning: All weights are `NA` or 0 in treatment group "0".</code></pre>
</div>
<div class="sourceCode cell-code" id="cb48"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb48-1"><a href="#cb48-1" aria-hidden="true" tabindex="-1"></a><span class="fu">summary</span>(balance_beam_2)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>                 Summary of weights

- Weight ranges:

        Min                                 Max
treated   1                              ||   1
control   0   ||                              0

- Units with the 5 most extreme weights by group:
                             
           5   4   3   2    1
 treated   1   1   1   1    1
         294 293 292 291 1991
 control   0   0   0   0    0

- Weight statistics:

        Coef of Var MAD Entropy # Zeros
treated           0   0       0       0
control                       0    4091

- Effective Sample Sizes:

           Control Treated
Unweighted    4091     290
Weighted               290</code></pre>
</div>
<div class="sourceCode cell-code" id="cb50"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb50-1"><a href="#cb50-1" aria-hidden="true" tabindex="-1"></a><span class="fu">love.plot</span>(balance_beam_2)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-error">
<pre><code>Error in `love.plot()`:
! All weights are zero when treat is "0".</code></pre>
</div>
<div class="sourceCode cell-code" id="cb52"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb52-1"><a href="#cb52-1" aria-hidden="true" tabindex="-1"></a><span class="fu">bal.plot</span>(balance_beam_2, <span class="at">which =</span> <span class="st">"both"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>No `var.name` was provided. Displaying balance for bw.</code></pre>
</div>
<div class="cell-output-display">
<p><img src="Homework-08_files/figure-html/unnamed-chunk-9-1.png" class="img-fluid" width="672"></p>
</div>
</div>
<p>Still no cigar.</p>
<p>Let’s try another formula—this time, let’s cut out some of the pregnancy risks.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb54"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb54-1"><a href="#cb54-1" aria-hidden="true" tabindex="-1"></a>treat_formula_3 <span class="ot">&lt;-</span> <span class="st">"treat ~ bw + bwg + preterm + st99 + prenatal + booze + momage + I(momage^2) + momed"</span></span>
<span id="cb54-2"><a href="#cb54-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb54-3"><a href="#cb54-3" aria-hidden="true" tabindex="-1"></a>balance_beam_3 <span class="ot">&lt;-</span> <span class="fu">weightit</span>(<span class="fu">as.formula</span>(treat_formula_3), </span>
<span id="cb54-4"><a href="#cb54-4" aria-hidden="true" tabindex="-1"></a>                         <span class="at">data =</span> d, </span>
<span id="cb54-5"><a href="#cb54-5" aria-hidden="true" tabindex="-1"></a>                         <span class="at">estimand =</span> <span class="st">"ATT"</span>, </span>
<span id="cb54-6"><a href="#cb54-6" aria-hidden="true" tabindex="-1"></a>                         <span class="at">method =</span> <span class="st">"ebal"</span>, </span>
<span id="cb54-7"><a href="#cb54-7" aria-hidden="true" tabindex="-1"></a>                         <span class="at">moments =</span> <span class="dv">3</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>Warning: The estimated weights do not balance the covariates, indicating the
optimization arrived at a degenerate solution. Try decreasing the number of
variables supplied to the optimization.</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Warning: All weights are `NA` or 0 in treatment group "0".</code></pre>
</div>
<div class="sourceCode cell-code" id="cb57"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb57-1"><a href="#cb57-1" aria-hidden="true" tabindex="-1"></a><span class="fu">summary</span>(balance_beam_3)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>                 Summary of weights

- Weight ranges:

        Min                                 Max
treated   1                              ||   1
control   0   ||                              0

- Units with the 5 most extreme weights by group:
                             
           5   4   3   2    1
 treated   1   1   1   1    1
         294 293 292 291 2616
 control   0   0   0   0    0

- Weight statistics:

        Coef of Var MAD Entropy # Zeros
treated           0   0       0       0
control                       0    4091

- Effective Sample Sizes:

           Control Treated
Unweighted    4091     290
Weighted               290</code></pre>
</div>
<div class="sourceCode cell-code" id="cb59"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb59-1"><a href="#cb59-1" aria-hidden="true" tabindex="-1"></a><span class="fu">love.plot</span>(balance_beam_3)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-error">
<pre><code>Error in `love.plot()`:
! All weights are zero when treat is "0".</code></pre>
</div>
<div class="sourceCode cell-code" id="cb61"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb61-1"><a href="#cb61-1" aria-hidden="true" tabindex="-1"></a><span class="fu">bal.plot</span>(balance_beam_3, <span class="at">which =</span> <span class="st">"both"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>No `var.name` was provided. Displaying balance for bw.</code></pre>
</div>
<div class="cell-output-display">
<p><img src="Homework-08_files/figure-html/unnamed-chunk-10-1.png" class="img-fluid" width="672"></p>
</div>
</div>
<p>Damn, foiled again.</p>
<p>How about version 4, which includes pregnancy risks and all of the states, but not the mothers’ ages?</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb63"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb63-1"><a href="#cb63-1" aria-hidden="true" tabindex="-1"></a>treat_formula_4 <span class="ot">&lt;-</span> <span class="st">"treat ~ bw + bwg + preterm + st99 + st5 + st9 + st12 + st25 + st36 + st42 + st48 + st53 + prenatal + cig + booze + work.dur + momed"</span></span>
<span id="cb63-2"><a href="#cb63-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb63-3"><a href="#cb63-3" aria-hidden="true" tabindex="-1"></a>balance_beam_4 <span class="ot">&lt;-</span> <span class="fu">weightit</span>(<span class="fu">as.formula</span>(treat_formula_4), </span>
<span id="cb63-4"><a href="#cb63-4" aria-hidden="true" tabindex="-1"></a>                         <span class="at">data =</span> d, </span>
<span id="cb63-5"><a href="#cb63-5" aria-hidden="true" tabindex="-1"></a>                         <span class="at">estimand =</span> <span class="st">"ATT"</span>, </span>
<span id="cb63-6"><a href="#cb63-6" aria-hidden="true" tabindex="-1"></a>                         <span class="at">method =</span> <span class="st">"ebal"</span>, </span>
<span id="cb63-7"><a href="#cb63-7" aria-hidden="true" tabindex="-1"></a>                         <span class="at">moments =</span> <span class="dv">3</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>Warning: The estimated weights do not balance the covariates, indicating the
optimization arrived at a degenerate solution. Try decreasing the number of
variables supplied to the optimization.</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Warning: All weights are `NA` or 0 in treatment group "0".</code></pre>
</div>
<div class="sourceCode cell-code" id="cb66"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb66-1"><a href="#cb66-1" aria-hidden="true" tabindex="-1"></a><span class="fu">summary</span>(balance_beam_4)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>                 Summary of weights

- Weight ranges:

        Min                                 Max
treated   1                              ||   1
control   0   ||                              0

- Units with the 5 most extreme weights by group:
                             
           5   4   3   2    1
 treated   1   1   1   1    1
         294 293 292 291 1915
 control   0   0   0   0    0

- Weight statistics:

        Coef of Var MAD Entropy # Zeros
treated           0   0       0       0
control                       0    4091

- Effective Sample Sizes:

           Control Treated
Unweighted    4091     290
Weighted               290</code></pre>
</div>
<div class="sourceCode cell-code" id="cb68"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb68-1"><a href="#cb68-1" aria-hidden="true" tabindex="-1"></a><span class="fu">love.plot</span>(balance_beam_4)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-error">
<pre><code>Error in `love.plot()`:
! All weights are zero when treat is "0".</code></pre>
</div>
<div class="sourceCode cell-code" id="cb70"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb70-1"><a href="#cb70-1" aria-hidden="true" tabindex="-1"></a><span class="fu">bal.plot</span>(balance_beam_4, <span class="at">which =</span> <span class="st">"both"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>No `var.name` was provided. Displaying balance for bw.</code></pre>
</div>
<div class="cell-output-display">
<p><img src="Homework-08_files/figure-html/unnamed-chunk-11-1.png" class="img-fluid" width="672"></p>
</div>
</div>
<p>Last try—cutting out the states <em>and</em> work variables, this time.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb72"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb72-1"><a href="#cb72-1" aria-hidden="true" tabindex="-1"></a>treat_formula_5 <span class="ot">&lt;-</span> <span class="st">"treat ~ bw + bwg + preterm + st99 + prenatal + cig + booze + momage + I(momage^2) + momed"</span></span>
<span id="cb72-2"><a href="#cb72-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb72-3"><a href="#cb72-3" aria-hidden="true" tabindex="-1"></a>balance_beam_5 <span class="ot">&lt;-</span> <span class="fu">weightit</span>(<span class="fu">as.formula</span>(treat_formula_5), </span>
<span id="cb72-4"><a href="#cb72-4" aria-hidden="true" tabindex="-1"></a>                         <span class="at">data =</span> d, </span>
<span id="cb72-5"><a href="#cb72-5" aria-hidden="true" tabindex="-1"></a>                         <span class="at">estimand =</span> <span class="st">"ATT"</span>, </span>
<span id="cb72-6"><a href="#cb72-6" aria-hidden="true" tabindex="-1"></a>                         <span class="at">method =</span> <span class="st">"ebal"</span>, </span>
<span id="cb72-7"><a href="#cb72-7" aria-hidden="true" tabindex="-1"></a>                         <span class="at">moments =</span> <span class="dv">3</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>Warning: The estimated weights do not balance the covariates, indicating the
optimization arrived at a degenerate solution. Try decreasing the number of
variables supplied to the optimization.</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Warning: All weights are `NA` or 0 in treatment group "0".</code></pre>
</div>
<div class="sourceCode cell-code" id="cb75"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb75-1"><a href="#cb75-1" aria-hidden="true" tabindex="-1"></a><span class="fu">summary</span>(balance_beam_5)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>                 Summary of weights

- Weight ranges:

        Min                                 Max
treated   1                              ||   1
control   0   ||                              0

- Units with the 5 most extreme weights by group:
                             
           5   4   3   2    1
 treated   1   1   1   1    1
         294 293 292 291 2481
 control   0   0   0   0    0

- Weight statistics:

        Coef of Var MAD Entropy # Zeros
treated           0   0       0       0
control                       0    4091

- Effective Sample Sizes:

           Control Treated
Unweighted    4091     290
Weighted               290</code></pre>
</div>
<div class="sourceCode cell-code" id="cb77"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb77-1"><a href="#cb77-1" aria-hidden="true" tabindex="-1"></a><span class="fu">love.plot</span>(balance_beam_5)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-error">
<pre><code>Error in `love.plot()`:
! All weights are zero when treat is "0".</code></pre>
</div>
</div>
<p>Nothing! If anything, the balance plot indicates that our imbalance is actually getting worse.</p>
<section id="lastly-lets-find-the-att-using-one-of-these-models." class="level3">
<h3 class="anchored" data-anchor-id="lastly-lets-find-the-att-using-one-of-these-models.">Lastly, let’s find the ATT using one of these models.</h3>
<p>Entropy balancing is out, but what can we use propensity scores or CBPS to tell us about the ATT?</p>
<p>Let’s first find the naive estimate of treatment (AKA, without applying weights)</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb79"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb79-1"><a href="#cb79-1" aria-hidden="true" tabindex="-1"></a><span class="fu">summary</span>(<span class="fu">lm</span>(ppvtr<span class="fl">.36</span> <span class="sc">~</span> treat, </span>
<span id="cb79-2"><a href="#cb79-2" aria-hidden="true" tabindex="-1"></a>           <span class="at">data =</span> d))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>
Call:
lm(formula = ppvtr.36 ~ treat, data = d)

Residuals:
    Min      1Q  Median      3Q     Max 
-59.114 -13.114   1.047  14.497  42.972 

Coefficients:
            Estimate Std. Error t value Pr(&gt;|t|)    
(Intercept)  86.0280     0.3137 274.220  &lt; 2e-16 ***
treat         6.0857     1.2194   4.991 6.24e-07 ***
---
Signif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1

Residual standard error: 20.07 on 4379 degrees of freedom
Multiple R-squared:  0.005656,  Adjusted R-squared:  0.005429 
F-statistic: 24.91 on 1 and 4379 DF,  p-value: 6.241e-07</code></pre>
</div>
</div>
<p>The naive estimate of treatment is <code>6.086</code>.</p>
<p>If we do apply weights (from the CBPS formula), our output is as follows:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb81"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb81-1"><a href="#cb81-1" aria-hidden="true" tabindex="-1"></a>cbps_att <span class="ot">&lt;-</span> <span class="fu">lm</span>(ppvtr<span class="fl">.36</span> <span class="sc">~</span> treat, </span>
<span id="cb81-2"><a href="#cb81-2" aria-hidden="true" tabindex="-1"></a>               <span class="at">data =</span> d, </span>
<span id="cb81-3"><a href="#cb81-3" aria-hidden="true" tabindex="-1"></a>               <span class="at">weights =</span> CBPS1<span class="sc">$</span>weights)</span>
<span id="cb81-4"><a href="#cb81-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb81-5"><a href="#cb81-5" aria-hidden="true" tabindex="-1"></a><span class="fu">tidy</span>(cbps_att, <span class="at">conf.int =</span> <span class="cn">TRUE</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-error">
<pre><code>Error in tidy(cbps_att, conf.int = TRUE): could not find function "tidy"</code></pre>
</div>
</div>
<p>Based off of the CBPS1 weights, the output indicates that receiving treatment increases IQ (or <code>ppvtr.36</code>) by 15.75 points.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb83"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb83-1"><a href="#cb83-1" aria-hidden="true" tabindex="-1"></a>ps_att <span class="ot">&lt;-</span> <span class="fu">lm</span>(ppvtr<span class="fl">.36</span> <span class="sc">~</span> treat, </span>
<span id="cb83-2"><a href="#cb83-2" aria-hidden="true" tabindex="-1"></a>               <span class="at">data =</span> d, </span>
<span id="cb83-3"><a href="#cb83-3" aria-hidden="true" tabindex="-1"></a>               <span class="at">weights =</span> W1<span class="sc">$</span>weights)</span>
<span id="cb83-4"><a href="#cb83-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb83-5"><a href="#cb83-5" aria-hidden="true" tabindex="-1"></a><span class="fu">tidy</span>(ps_att, <span class="at">conf.int =</span> <span class="cn">TRUE</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-error">
<pre><code>Error in tidy(ps_att, conf.int = TRUE): could not find function "tidy"</code></pre>
</div>
</div>
<p>Based on the propensity score weights, our output is even less precise, estimating that receiving treatment increases <code>ppvtr.36</code> by <em>39.1</em> points, which is even less likely than the CBPS prediction.</p>
</section>
</section>

</main>
<!-- /main column -->
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const isCodeAnnotation = (el) => {
    for (const clz of el.classList) {
      if (clz.startsWith('code-annotation-')) {                     
        return true;
      }
    }
    return false;
  }
  const clipboard = new window.ClipboardJS('.code-copy-button', {
    text: function(trigger) {
      const codeEl = trigger.previousElementSibling.cloneNode(true);
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
    }
  });
  clipboard.on('success', function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  });
  function tippyHover(el, contentFn) {
    const config = {
      allowHTML: true,
      content: contentFn,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start'
    };
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      return note.innerHTML;
    });
  }
      let selectedAnnoteEl;
      const selectorForAnnotation = ( cell, annotation) => {
        let cellAttr = 'data-code-cell="' + cell + '"';
        let lineAttr = 'data-code-annotation="' +  annotation + '"';
        const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
        return selector;
      }
      const selectCodeLines = (annoteEl) => {
        const doc = window.document;
        const targetCell = annoteEl.getAttribute("data-target-cell");
        const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
        const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
        const lines = annoteSpan.getAttribute("data-code-lines").split(",");
        const lineIds = lines.map((line) => {
          return targetCell + "-" + line;
        })
        let top = null;
        let height = null;
        let parent = null;
        if (lineIds.length > 0) {
            //compute the position of the single el (top and bottom and make a div)
            const el = window.document.getElementById(lineIds[0]);
            top = el.offsetTop;
            height = el.offsetHeight;
            parent = el.parentElement.parentElement;
          if (lineIds.length > 1) {
            const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
            const bottom = lastEl.offsetTop + lastEl.offsetHeight;
            height = bottom - top;
          }
          if (top !== null && height !== null && parent !== null) {
            // cook up a div (if necessary) and position it 
            let div = window.document.getElementById("code-annotation-line-highlight");
            if (div === null) {
              div = window.document.createElement("div");
              div.setAttribute("id", "code-annotation-line-highlight");
              div.style.position = 'absolute';
              parent.appendChild(div);
            }
            div.style.top = top - 2 + "px";
            div.style.height = height + 4 + "px";
            let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
            if (gutterDiv === null) {
              gutterDiv = window.document.createElement("div");
              gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
              gutterDiv.style.position = 'absolute';
              const codeCell = window.document.getElementById(targetCell);
              const gutter = codeCell.querySelector('.code-annotation-gutter');
              gutter.appendChild(gutterDiv);
            }
            gutterDiv.style.top = top - 2 + "px";
            gutterDiv.style.height = height + 4 + "px";
          }
          selectedAnnoteEl = annoteEl;
        }
      };
      const unselectCodeLines = () => {
        const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
        elementsIds.forEach((elId) => {
          const div = window.document.getElementById(elId);
          if (div) {
            div.remove();
          }
        });
        selectedAnnoteEl = undefined;
      };
      // Attach click handler to the DT
      const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
      for (const annoteDlNode of annoteDls) {
        annoteDlNode.addEventListener('click', (event) => {
          const clickedEl = event.target;
          if (clickedEl !== selectedAnnoteEl) {
            unselectCodeLines();
            const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
            if (activeEl) {
              activeEl.classList.remove('code-annotation-active');
            }
            selectCodeLines(clickedEl);
            clickedEl.classList.add('code-annotation-active');
          } else {
            // Unselect the line
            unselectCodeLines();
            clickedEl.classList.remove('code-annotation-active');
          }
        });
      }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script>
</div> <!-- /content -->



</body></html>